<!DOCTYPE html>
<html>
<head>
    <title>Tabletop Library Planning Tool</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f7;
        }

        h1 {
            font-size: 48px;
            margin-bottom: 30px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #3478F6;
            color: #3478F6;
            background: white;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            background: #3478F6;
            color: white;
        }

        .tab:hover {
            background: #3478F6;
            color: white;
        }

        .content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content.active {
            display: block;
        }

        .config-section {
            margin-bottom: 30px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .config-item input {
            width: 60px;  
            padding: 5px;
            border: 1px solid #d2d2d7;
            border-radius: 5px;
            font-size: 14px;
        }

        .config-item input:focus {
            outline: none;
            border-color: #3478F6;
        }

        .plan-card {
            border: 1px solid #d2d2d7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .plan-features {
            margin-top: 10px;
        }

        .plan-features ul {
            margin: 0;
            padding-left: 20px;
        }

        .save-button {
            background: #3478F6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .save-button:hover {
            background: #2758c2;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #f8f8fa;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.5;
        }

        .revenue-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .revenue-section h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        #persona-revenues, #revenue-breakdown {
            display: grid;
            gap: 15px;
        }

        .persona-revenue, .revenue-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .persona-revenue .details {
            display: flex;
            flex-direction: column;
        }

        .persona-revenue .member-count {
            color: #666;
            font-size: 0.9em;
        }

        #total-revenue {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
            font-weight: bold;
            font-size: 1.2em;
            text-align: right;
        }

        .revenue-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
        }

        .revenue-item .percentage {
            color: #666;
        }

        .summary-box {
            background: #f0f7ff;
            border: 2px solid #3478F6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }

        .summary-box h2 {
            color: #3478F6;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .summary-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .summary-box li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <h1>Tabletop Library Planning Tools</h1>
    
    <div class="tab-container">
        <a href="#" class="tab active" onclick="switchTab('planner')">Planner</a>
        <a href="#" class="tab" onclick="switchTab('optimizer')">Plan Optimizer</a>
        <a href="#" class="tab" onclick="switchTab('personas')">Persona Optimization</a>
        <a href="#" class="tab" onclick="switchTab('revenue')">Revenue</a>
        <a href="#" class="tab" onclick="switchTab('config')">Config</a>
    </div>

    <div class="content active" id="planner-content">
        <div class="summary-box">
            <div id="planner-summary"></div>
        </div>
        <pre id="planner-output">Loading...</pre>
    </div>

    <div class="content" id="optimizer-content">
        <pre id="optimizer-output">Loading...</pre>
    </div>

    <div class="content" id="personas-content">
        <pre id="personas-output">Loading...</pre>
    </div>

    <div class="content" id="config-content">
        <div class="config-section">
            <h3>Personas</h3>
            
            <h4>Persona Distribution</h4>
            <div class="config-grid" id="persona-distribution">
                <!-- Will be populated by JavaScript -->
            </div>

            <h4>Persona Details</h4>
            <div class="config-grid" id="persona-details">
                <!-- Will be populated by JavaScript -->
            </div>

            <h4>Spending Assumptions</h4>
            <div class="config-grid" id="spending-assumptions">
                <!-- Will be populated by JavaScript -->
            </div>

            <h3>Plans</h3>
            <div class="config-grid" id="plans">
                <!-- Will be populated by JavaScript -->
            </div>

            <button onclick="saveConfig()" class="save-button">Save Changes</button>
        </div>
    </div>

    <div class="content" id="revenue-content">
        <div id="revenue-content">
            <h2>Monthly Revenue Projection</h2>
            <div class="revenue-section">
                <h3>Revenue by Persona Type</h3>
                <div id="persona-revenues"></div>
            </div>
            <div class="revenue-section">
                <h3>Revenue Breakdown</h3>
                <div id="revenue-breakdown"></div>
                <div id="total-revenue"></div>
            </div>
        </div>
    </div>

    <script>
        // Define input mappings globally
        const personaInputs = {
            'casual': '5',
            'everyday': '6',
            'families': '7',
            'hobbyists': '8',
            'students': '9'
        };

        const personaDetailInputs = {
            'casual': {
                price: '10',
                guests: '11',
                reserved: '12',
                mixed: '13',
                passes: '14',
                discount: '15',
                retail: '40',
                snacks: '41'
            },
            'everyday': {
                price: '16',
                guests: '17',
                reserved: '18',
                mixed: '19',
                passes: '20',
                discount: '21',
                retail: '42',
                snacks: '43'
            },
            'families': {
                price: '22',
                guests: '23',
                reserved: '24',
                mixed: '25',
                passes: '26',
                discount: '27',
                retail: '44',
                snacks: '45'
            },
            'hobbyists': {
                price: '28',
                guests: '29',
                reserved: '30',
                mixed: '31',
                passes: '32',
                discount: '33',
                retail: '46',
                snacks: '47'
            },
            'students': {
                price: '34',
                guests: '35',
                reserved: '36',
                mixed: '37',
                passes: '38',
                discount: '39',
                retail: '48',
                snacks: '49'
            }
        };

        const planPriceInputs = {
            'basic': '50',
            'standard': '52',
            'family': '51'
        };

        function switchTab(tabName) {
            // Hide all content sections
            document.querySelectorAll('.content').forEach(section => {
                section.classList.remove('active');
            });
            // Show selected content section
            document.getElementById(`${tabName}-content`).classList.add('active');
            
            // Update tab styling
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load data for the selected tab
            if (tabName === 'planner') {
                loadData('planner');
            } else if (tabName === 'optimizer') {
                loadData('optimizer');
            } else if (tabName === 'personas') {
                loadData('personas');
            } else if (tabName === 'revenue') {
                loadRevenue();
            }
        }

        function loadData(tabName) {
            let endpoint;
            switch (tabName) {
                case 'planner':
                    endpoint = '/api/planner';
                    break;
                case 'optimizer':
                    endpoint = '/api/optimizer';
                    break;
                case 'personas':
                    endpoint = '/api/personas';
                    break;
                default:
                    console.error('Unknown tab:', tabName);
                    return;
            }

            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (tabName === 'planner') {
                        document.getElementById('planner-summary').innerHTML = data.summary;
                        document.getElementById('planner-output').textContent = data.detailed_output;
                    } else {
                        document.getElementById(`${tabName}-output`).innerHTML = `<pre>${data.output}</pre>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (tabName === 'planner') {
                        document.getElementById('planner-output').innerHTML = 'Error loading data';
                    } else {
                        document.getElementById(`${tabName}-output`).innerHTML = 'Error loading data';
                    }
                });
        }

        async function loadRevenue() {
            try {
                const response = await fetch('/api/revenue');
                const data = await response.json();
                
                // Update persona revenues
                const personaRevenuesDiv = document.getElementById('persona-revenues');
                personaRevenuesDiv.innerHTML = '';
                
                for (const [persona, revenue] of Object.entries(data.persona_revenues)) {
                    const personaDiv = document.createElement('div');
                    personaDiv.className = 'persona-revenue';
                    const planType = revenue.plan_type.charAt(0).toUpperCase() + revenue.plan_type.slice(1);
                    let extrasString = '';
                    if (revenue.extra_guest_passes > 0) {
                        extrasString = ` +${revenue.extra_guest_passes} guest passes`;
                    }
                    if (revenue.is_family_plan) {
                        extrasString += ', +family plan';
                    }
                    personaDiv.innerHTML = `
                        <div class="persona-header">
                            <strong>${capitalize(persona)}</strong> (${Math.round(revenue.member_count)} members)
                        </div>
                        <div class="plan-details" style="margin-top: 4px;">
                            ${planType} plan.${extrasString}
                        </div>
                        <div class="revenue-details" style="margin-top: 8px;">
                            $${revenue.total.toFixed(2)}/mo ($${revenue.membership.toFixed(2)} membership + $${revenue.extras.toFixed(2)} extras)
                        </div>
                    `;
                    personaRevenuesDiv.appendChild(personaDiv);
                }
                
                // Update revenue breakdown
                const breakdownDiv = document.getElementById('revenue-breakdown');
                breakdownDiv.innerHTML = '';
                
                const breakdown = data.revenue_breakdown;
                const total = data.total_revenue;
                
                const categories = {
                    'memberships': 'Memberships',
                    'guests': 'Guests w/Reservations',
                    'mixed_events': 'Guests w/Mixed Events',
                    'snacks': 'Snacks',
                    'retail': 'Retail'
                };
                
                for (const [key, label] of Object.entries(categories)) {
                    const amount = breakdown[key];
                    const percentage = (amount / total * 100).toFixed(1);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'revenue-item';
                    itemDiv.innerHTML = `
                        <div>${label}</div>
                        <div>$${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="percentage">${percentage}%</div>
                    `;
                    breakdownDiv.appendChild(itemDiv);
                }
                
                // Update total revenue
                const totalDiv = document.getElementById('total-revenue');
                totalDiv.innerHTML = `Total Monthly Revenue: $${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
            } catch (error) {
                console.error('Error loading revenue data:', error);
            }
        }

        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Load config values when the page loads
        window.addEventListener('load', function() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    console.log('Received config:', config);  // Debug log
                    
                    // Populate persona distribution
                    const distDiv = document.getElementById('persona-distribution');
                    distDiv.innerHTML = '';
                    for (const [persona, percentage] of Object.entries(config.distribution)) {
                        const displayName = persona.charAt(0).toUpperCase() + persona.slice(1);
                        distDiv.innerHTML += `
                            <div class="config-item">
                                <label>${displayName} (%)</label>
                                <input type="number" devinid="${personaInputs[persona]}" value="${(percentage * 100).toFixed(1)}" 
                                       step="0.1" min="0" max="100">
                            </div>`;
                    }

                    // Populate persona details
                    const detailsDiv = document.getElementById('persona-details');
                    detailsDiv.innerHTML = '';
                    for (const [persona, details] of Object.entries(config.personas)) {
                        const displayName = persona.charAt(0).toUpperCase() + persona.slice(1);
                        detailsDiv.innerHTML += `
                            <div class="config-item">
                                <h4>${displayName}</h4>
                                <label>Price ($)</label>
                                <input type="number" devinid="${personaDetailInputs[persona].price}" value="${details.price}" step="1">
                                <label>Guests per Reserved Visit</label>
                                <input type="number" devinid="${personaDetailInputs[persona].guests}" value="${details.guests_per_reserved}" step="0.5">
                                <label>Reserved Visits</label>
                                <input type="number" devinid="${personaDetailInputs[persona].reserved}" value="${details.reserved_visits}" step="1">
                                <label>Mixed Visits</label>
                                <input type="number" devinid="${personaDetailInputs[persona].mixed}" value="${details.mixed_visits}" step="0.5">
                                <label>Guest Passes</label>
                                <input type="number" devinid="${personaDetailInputs[persona].passes}" value="${details.guest_passes}" step="1">
                                <label>Guest Discount (%)</label>
                                <input type="number" devinid="${personaDetailInputs[persona].discount}" value="${details.guest_discount * 100}" step="5">
                            </div>`;
                    }

                    // Populate spending assumptions
                    const spendingDiv = document.getElementById('spending-assumptions');
                    spendingDiv.innerHTML = '';
                    for (const [persona, retail] of Object.entries(config.spending_assumptions.retail_monthly)) {
                        const displayName = persona.charAt(0).toUpperCase() + persona.slice(1);
                        const snacks = config.spending_assumptions.snacks[persona];
                        spendingDiv.innerHTML += `
                            <div class="config-item">
                                <h4>${displayName}</h4>
                                <label>Monthly Retail ($)</label>
                                <input type="number" devinid="${personaDetailInputs[persona].retail}" value="${retail}" step="0.01">
                                <label>Snacks per Visit ($)</label>
                                <input type="number" devinid="${personaDetailInputs[persona].snacks}" value="${snacks}" step="0.01">
                            </div>`;
                    }

                    // Populate plans
                    const plansDiv = document.getElementById('plans');
                    plansDiv.innerHTML = '';
                    const planPrices = config.plan_prices;
                    for (const [plan, price] of Object.entries(planPrices)) {
                        const displayName = plan.replace('_plan_price', '').split('_').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                        plansDiv.innerHTML += `
                            <div class="plan-card">
                                <h4>${displayName} Plan</h4>
                                <label>Price ($)</label>
                                <input type="number" devinid="${planPriceInputs[plan.replace('_plan_price', '')]}" value="${price}" step="1">
                                <div class="plan-features">
                                    <h5>Features:</h5>
                                    <ul>
                                        ${config.plans[plan.replace('_plan_price', '').toLowerCase()].features.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                });
        });

        function saveConfig() {
            const config = {
                distribution: {},
                personas: {},
                spending_assumptions: {
                    retail_monthly: {},
                    snacks: {}
                },
                plan_prices: {}
            };

            // Initialize config.distribution
            config.distribution = {};
            
            console.log('Starting saveConfig...');
            
            // Collect persona distribution with validation
            Object.entries(personaInputs).forEach(([persona, devinid]) => {
                const input = document.querySelector(`input[type="number"][devinid="${devinid}"]`);
                if (input && !isNaN(input.value) && input.value !== '') {
                    const percentValue = parseFloat(input.value);
                    const decimalValue = percentValue / 100;
                    config.distribution[persona] = decimalValue;
                    console.log(`Distribution for ${persona}: ${percentValue}% (${decimalValue} decimal)`);
                } else {
                    console.warn(`Missing or invalid value for persona: ${persona}`);
                }
            });

            // Use the globally defined personaDetailInputs

            // Collect persona details using devinids
            Object.entries(personaDetailInputs).forEach(([persona, ids]) => {
                const priceInput = document.querySelector(`input[devinid="${ids.price}"]`);
                const guestsInput = document.querySelector(`input[devinid="${ids.guests}"]`);
                const reservedInput = document.querySelector(`input[devinid="${ids.reserved}"]`);
                const mixedInput = document.querySelector(`input[devinid="${ids.mixed}"]`);
                const passesInput = document.querySelector(`input[devinid="${ids.passes}"]`);
                const discountInput = document.querySelector(`input[devinid="${ids.discount}"]`);
                
                // Ensure all numeric fields have default values of 0
                const price = priceInput && !isNaN(priceInput.value) && priceInput.value !== '' ? parseFloat(priceInput.value) : 0;
                const guests = guestsInput && !isNaN(guestsInput.value) && guestsInput.value !== '' ? parseFloat(guestsInput.value) : 0;
                const reserved = reservedInput && !isNaN(reservedInput.value) && reservedInput.value !== '' ? parseInt(reservedInput.value) : 0;
                const mixed = mixedInput && !isNaN(mixedInput.value) && mixedInput.value !== '' ? parseFloat(mixedInput.value) : 0;
                const passes = passesInput && !isNaN(passesInput.value) && passesInput.value !== '' ? parseInt(passesInput.value) : 0;
                const discount = discountInput && !isNaN(discountInput.value) && discountInput.value !== '' ? parseFloat(discountInput.value) / 100 : 0;
                
                config.personas[persona] = {
                    price: price,
                    guests_per_reserved: guests,
                    reserved_visits: reserved,
                    mixed_visits: mixed,
                    guest_passes: passes,
                    guest_discount: discount
                };

                // Collect spending assumptions
                const retailInput = document.querySelector(`input[devinid="${ids.retail}"]`);
                const snacksInput = document.querySelector(`input[devinid="${ids.snacks}"]`);
                config.spending_assumptions.retail_monthly[persona] = retailInput && !isNaN(retailInput.value) ? parseFloat(retailInput.value) : 0;
                config.spending_assumptions.snacks[persona] = snacksInput && !isNaN(snacksInput.value) ? parseFloat(snacksInput.value) : 0;
            });

            // Collect plan prices using devinids
            const planPriceInputs = {
                basic_plan_price: document.querySelector('input[devinid="50"]'),
                standard_plan_price: document.querySelector('input[devinid="52"]'),
                family_plan_price: document.querySelector('input[devinid="51"]')
            };
            
            config.plan_prices = {
                basic_plan_price: planPriceInputs.basic_plan_price && !isNaN(planPriceInputs.basic_plan_price.value) ? parseFloat(planPriceInputs.basic_plan_price.value) : 0,
                standard_plan_price: planPriceInputs.standard_plan_price && !isNaN(planPriceInputs.standard_plan_price.value) ? parseFloat(planPriceInputs.standard_plan_price.value) : 0,
                family_plan_price: planPriceInputs.family_plan_price && !isNaN(planPriceInputs.family_plan_price.value) ? parseFloat(planPriceInputs.family_plan_price.value) : 0
            };

            console.log('Final config:', JSON.stringify(config, null, 2));
            
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to save configuration');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('Configuration saved successfully!');
                console.log('Save successful:', data);
                // Refresh all tabs to show updated values
                loadData('planner');
                loadData('optimizer');
                loadData('personas');
                loadRevenue();
            })
            .catch(error => {
                console.error('Save failed:', error.message);
                console.error('Config data being sent:', JSON.stringify(config, null, 2));
                alert('Error: ' + error.message);
            });
        }

        // Load initial data
        loadData('planner');
    </script>
</body>
</html>
